{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="{% static 'merger.css' %}">
    <title>Video Concatenator</title>
</head>
<body>
<div class="root">
    <header>
        <img src="{% static 'assets/white_logo.svg' %}" alt="logo" onclick="window.location.href='{% url 'account:home' %}'" style="cursor: pointer;">

        <div class="account">
            <h5>Megre Credits Remaining: {{ request.user.profile.merge_credits }}</h5>
            <div class="user">
                <img src="{% static 'assets/user.svg' %}" alt="user">
            </div>
        </div>
    </header>
    <div class="menu">
        <ul>
            <li onclick="window.location.href='{% url "subs:home" %}'">Manage Subscription</li>
            <li>Credit left <span>{{request.user.profile.merge_credits  }}</span></li>
            <li onclick="window.location.href='{% url "account:logout" %}'">Logout</li>
        </ul>
    </div>
    <div class="content">
        <div class="video_manager">
            <h1>Video Merger</h1>
            <form id="uploadForm" class="upload_files" action="{% url 'merger:upload_files' %}" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="input_block">
                    <div class="upload_file_wrapper">
                        <h4>Upload Your Short Videos: <span>(Maximum 10)</span></h4>
                        <label for="short_videos">
                            <span class="button">
                                <img src="{% static 'assets/upload_gray.svg' %}" alt="upload">
                                Choose file
                            </span>
                        </label>
                        <input id="short_videos" name="short_videos" type="file" accept="video/mp4,video/x-m4v,video/*" multiple required>
                        <p class="short-vid-info">
                        <span id="uploadedCount">Uploaded: 0</span>
                        <span id="remainingCount">Remaining: 10</span>
                        </p>
                        <p id="error-message">You can only upload a maximum of 10 short videos. refresh and try again.</p>
                    </div>
    
                    <div class="upload_file_wrapper">
                        <h4>Upload Your Large Video: <span>(Maximum 1)</span></h4>
                        <label for="large_videos">
                            <span class="button">
                                <img src="{% static 'assets/upload_gray.svg' %}" alt="upload">
                                Choose file
                            </span>
                        </label>
                        <input id="large_videos" name="large_videos" type="file" accept="video/mp4,video/x-m4v,video/*" required>
                        <p id="largeVideoName">No large video uploaded</p>
                    </div>
                </div>

                <!-- Progress bar -->
                <div id="progress-container" style="display: none;">
                    <div class="progress-bar-text">
                        <span class="uploading-text">Uploading</span>
                        <span id="progress-percentage" class="percentage-text">0%</span>
                    </div>
                    <div id="progress-bar">
                        <div id="progress"></div>
                    </div>
                </div>

                <button id="submit" type="submit">Upload and Process</button>   
            </form>
        </div>
    </div>
</div>
<script>
    const user = document.querySelector( ".user" );
    const menu = document.querySelector( ".menu" );
    user.addEventListener( "click", function () {
        if ( menu.style.display === "block" ) {
            menu.style.display = "none"
        } else {
            menu.style.display = "block"
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const shortVideosInput = document.getElementById("short_videos");
        const selectedFiles = [];

        shortVideosInput.addEventListener('change', function(event) {
            // Append selected files to the list of already selected files
            for (const file of event.target.files) {
                selectedFiles.push(file);
            }

            // Create a DataTransfer object to store the new list of files
            const dataTransfer = new DataTransfer();
            for (const file of selectedFiles) {
                dataTransfer.items.add(file);
            }

            // Replace the input's files with the new list of files
            shortVideosInput.files = dataTransfer.files;

            // Optionally log the selected files for debugging
            console.log("Files selected: ", shortVideosInput.files);
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const submitButton = document.getElementById("submit")
        const shortVideosInput = document.getElementById("short_videos");
        const largeVideoInput = document.getElementById("large_video");
        const errorMessage = document.getElementById('error-message');

        // Select the p elements for displaying counts and large video name
        const uploadedCountDisplay = document.getElementById('uploadedCount');
        const remainingCountDisplay = document.getElementById('remainingCount');

        let selectedShortVideos = [];

        // Handle short videos selection
        shortVideosInput.addEventListener('change', function(event) {
            // Reset the selectedShortVideos array to prevent recounting previous selections
            selectedShortVideos = Array.from(event.target.files);

            // Disable the input if 10 files are uploaded
            if (selectedShortVideos.length > 10) {
                shortVideosInput.disabled = true;
                submitButton.disabled = true;
                errorMessage.style.display = 'block'; 
            } else {
            shortVideosInput.disabled = false;
            submitButton.disabled = false;
            errorMessage.style.display = 'none';  // Hide the error message if under the limit
        }

            // Update the counts for uploaded and remaining videos
            updateCountDisplay();
        });


        // Update the display of uploaded and remaining videos
        function updateCountDisplay() {
            const uploaded = selectedShortVideos.length;
            const remaining = 10 - uploaded;

            uploadedCountDisplay.textContent = `Uploaded: ${uploaded}`;
            remainingCountDisplay.textContent = `Remaining: ${remaining}`;
        }
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const largeVideoInput = document.getElementById("large_videos");
        const largeVideoNameDisplay = document.getElementById('largeVideoName');

        // Handle large video selection and display its name
        largeVideoInput.addEventListener('change', function(event) {
            const largeVideoFile = event.target.files[0];
            if (largeVideoFile) {
                largeVideoNameDisplay.textContent = `Selected: ${largeVideoFile.name}`;
            } else {
                largeVideoNameDisplay.textContent = "No large video uploaded";
            }
        });
    });
</script>

<script>
    document.getElementById('uploadForm').addEventListener('submit', function (e) {
    e.preventDefault();  // Prevent default form submission
    
    const formData = new FormData(this);  // Create form data
    
    const xhr = new XMLHttpRequest();
    xhr.open('POST', this.action, true);
    
    // Display progress container when uploading starts
    document.getElementById('progress-container').style.display = 'block';

    // Update progress bar and percentage
    xhr.upload.onprogress = function (event) {
        if (event.lengthComputable) {
            const percentComplete = Math.round((event.loaded / event.total) * 100);
            document.getElementById('progress').style.width = percentComplete + '%';
            document.getElementById('progress-percentage').innerText = percentComplete + '%';
        }
    };

    // After the upload finishes
    xhr.onload = function () {
        if (xhr.status === 200) {
            // Redirect to the processing page (as in your view)
            window.location.href = xhr.responseURL;
        } else {
            alert('An error occurred while uploading the file.');
        }
    };

    // Send the form data with files
    xhr.send(formData);
});

</script>
</body>
</html>
